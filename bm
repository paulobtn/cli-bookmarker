#!/bin/sh

# Defaults settings

BM_LAUNCHER=${BROWSER} #browser that launches the URLs
BM_EDITOR=${EDITOR} # browser editor used with bm -e
BM_DB="./bookmarks" # where the bookmarks are stored
CONFIG_FILE="./bmrc"

#Helper Functions

# join string
function join_by { local d=${1-} f=${2-}; if shift 2; then printf %s "$f" "${@/#/$d}"; fi; }

# beautiful print of bookmark file
function bm_print(){ 
    local f=$1
    # cat -n $f | awk '{ $3 = "\t" $3; print}' | column -t -s $'\t' 
    cat -n $f | column -t -s $'\t' 
}

# should receive the URL that will be launched and the URLS array from the configuration file
# it returns the launcher associated with the last URL that matches with the URLS array
function get_launcher(){
    # URL we want to launch
    local LAUNCH_URL=$1
    # URLs associated with diferent launchers in the config file
    local URLS_ARR_N=$2[@]
    local URLS_ARR=("${!URLS_ARR_N}")
    #default launcher if no match occurs
    local LAUNCHER=$BM_LAUNCHER

    #check if there's a match in the URLS array
    for i in "${URLS_ARR[@]}"
    do
        local CURRENT_URL=`echo $i | awk '{print $1}'`
        local CURRENT_APP=`echo $i | awk '{print $2}'`
        if grep -q "$CURRENT_URL" <<< "$LAUNCH_URL"; then
            LAUNCHER=$CURRENT_APP
        fi
    done
    
    echo $LAUNCHER
}

# Parsing the configuration file
# These arrays represent the lines of each section of bmrc
GENERAL=()
URLS=()

if test -f "$CONFIG_FILE"; then 
    #Config file exists: Parse it and assign new defaults
    CURR="none";
    while IFS= read -r line
    do  
        if [ "$line" = "[general]" ]; then
            CURR="general"
        elif [ "$line" = "[urls]" ]; then
            CURR="urls"
        else
            # echo $CURR
            case $CURR in
                "general")
                    if [ ! -z "$line" ]; then
                        # [[ ! $line = \#* ]] && GENERAL+=("$line")
                        case $line in 
                            "#"*) 
                                # line is commented
                            ;; 
                            *) GENERAL+=("$line") 
                            ;;
                        esac
                    fi
                ;;
                "urls")
                    if [ ! -z "$line" ]; then
                        case $line in 
                            "#"*) 
                                # line is commented
                            ;; 
                            *) 
                            URLS+=("$line")
                            ;;
                        esac
                        
                    fi
                ;;
                *)
                ;;
            esac
        fi       
    done < $CONFIG_FILE

    echo ${GENERAL[@]}
    echo ${URLS[@]}

    # assign new config defaults
    for i in "${GENERAL[@]}"
    do
        gc=`echo $i | awk '{print $1}'`
        gs=`echo $i | awk '{print $2}'`
        case $gc in
            "bmfile")
                BM_DB=$gs
            ;;
            "editor")
                BM_EDITOR=$gs
            ;;
            "browser")
                BM_LAUNCHER=$gs
            ;;
            *)
                echo "invalid configuration"
            ;;
        esac
    done;
fi

#Main logic
case $1 in
    "-l") 
        #list bookmarks
        if [ -z "$2" ]; then 
            # no tag was given: list all
            # cat -n ${BM_DB} | awk '{ $3 = "\t" $3; print}' | column -t -s $'\t'
            bm_print ${BM_DB}
        else
            # tag was given: list only entries that match
             bm_print ${BM_DB} | grep "\[*$2"
        fi   
        ;;
    "-r") 
        ARR=()
        #remove bookmark if id is provided
        if [ ! -z "$2" ]; then        
            # add lines that will be deleted to an array           
            while (( "$#-1" )); do
                ARR+=($2d)
                shift 
            done
        else
            # user can select multiple entries. This returns the ids list that will be used by sed, example: [3d 5d 7d]
            # ARR=(`cat -n ./bookmarks | fzf -m | awk '{print $1"d"}' | xargs echo`)
            ARR=(`bm_print ${BM_DB} | fzf -m | awk '{print $1"d"}' | xargs echo`)
        fi
        #delete the lines
        if [ ${#ARR[@]} -ne "0" ]; then
            sed -i.bak `join_by ";" $(printf '%s\n' "${ARR[*]}")` ${BM_DB} 
        fi       
        ;;
    "-o"|""|"-s") 
        #open bookmark
        if [ -z "$2" ]; then 
            # id not provided: open search prompt
            # LINE=`cat -n ${BM_DB} | fzf`             
            LINE=`bm_print ${BM_DB} | fzf`             
            if [ ! -z "$LINE" ]; then 
                URL=`echo $LINE | awk '{print $2}'`
            fi
        else
            #id is provided: just take URL from array
            URL=`sed -n $2p ${BM_DB} | awk '{print $1}'`
        fi
        [ ! -z "$URL" ] && $(get_launcher $URL "URLS") $URL;
        ;;
    "-t")
        # open with tag search
        if [ ! -z "$2" ]; then 
            LINE=`bm_print ${BM_DB} | grep "\[*$2" | fzf`
            if [ ! -z "$LINE" ]; then 
                # open the selected url
                URL=`echo $LINE | awk '{print $2}'`
                [ ! -z "$URL" ] && $(get_launcher $URL "URLS") $URL > /dev/null;
            fi
        else
            echo "must have a tag as input"
        fi
        ;;
    "-e")
        #edit with text editor
        ${BM_EDITOR} ${BM_DB}
        ;;        
    *)
        if [[ ${1:0:1} == "-" ]]; then
            echo "invalid command"
        else
            #bm [url] [description]? [tags]? should add a bookmark
            SITE=$1
            TAGS=()
            TAGSSTR=""
            DESCR=""

            # check if there's description
            if [ ! -z "$2" ]; then
                DESCR="$2"
                #check if there's tags
                if [ ! -z "$3" ]; then 
                    while (( "$#" )); do
                        TAGS+=($3)
                        shift 
                    done
                    TAGSSTR=`printf '[%s] ' "${TAGS[*]}"`
                fi   

            fi
            # echo $SITE $DESCR $TAGSSTR >> bookmarks        
            # echo -e "$SITE $DESCR $TAGSSTR" >> ${BM_DB}q
            echo -e "$SITE\t$DESCR\t$TAGSSTR" >> ${BM_DB}   
        fi
        ;;
esac