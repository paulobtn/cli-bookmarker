#!/bin/sh

function join_by { local d=${1-} f=${2-}; if shift 2; then printf %s "$f" "${@/#/$d}"; fi; }

# will load from a configuration file, but for now it just takes the 
# default browser that should be exported in .profile or .bash_profile

BM_LAUNCHER=${BROWSER}
BM_EDITOR=${EDITOR}

case $1 in
    "-a") 
        #add bookmark
        DESCRIPTION=""
        if [[ $3 = "-d" ]]; then
            DESCRIPTION=$4
        else 
            DESCRIPTION=$3
        fi
        echo $2 $DESCRIPTION >> bookmarks
        ;;
    "-l") 
        #list bookmarks
        cat -n bookmarks
        ;;
    "-r") 
        arr=()
        #remove bookmark if id is provided
        if [ ! -z "$2" ]; then        
            # add lines that will be deleted to an array
            
            while (( "$#-1" )); do
                arr+=($2d)
                shift 
            done

            #delete the lines           

        else
            # user can select multiple entries. This returns the ids list that will be used by sed, example: [3d 5d 7d]
            arr=(`cat -n ./bookmarks | fzf -m | awk '{print $1"d"}' | xargs echo`)
        fi
        #delete the lines
        if [ ${#arr[@]} -ne "0" ]; then
            sed -i.bak `join_by ";" $(printf '%s\n' "${arr[*]}")` ./bookmarks 
        fi
        
        ;;
    "-o"|""|"-s") 
        #open bookmark
        if [ -z "$2" ]; then 
            # id not provided, open search prompt
            LINE=`cat -n ./bookmarks | fzf`
            echo $LINE
            if [ ! -z "$LINE" ]; then 
                # open the selected url
                $BM_LAUNCHER `echo $LINE | awk '{print $2}'`
            fi
        else
            #id is provided, open url
            $BM_LAUNCHER `sed -n $2p ./bookmarks | awk '{print $1}'`;
        fi
        ;;
    "-e")
        #edit with text editor
        ${BM_EDITOR} ./bookmarks 
        ;;        
    *)
        echo "invalid option";;
esac


